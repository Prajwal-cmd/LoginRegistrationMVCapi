@{
    ViewBag.Title = "Product Reviews (Lazy Loading Demo)";
}

<h2>@ViewBag.Title</h2>
<p>Click on 'View Reviews' to lazily load reviews for a product.</p>

<div class="row">
    <div class="col-md-5">
        <h3>Product List</h3>
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Product Name</th>
                    <th>Price</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="productsTableBody">
                <tr><td colspan="3">Loading products...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="col-md-7">
        <h3 id="reviewsHeader">Select a product to see reviews</h3>
        <div id="reviewsArea">
        </div>
    </div>
</div>

@section Scripts {
    <script type="text/javascript">
        $(document).ready(function () {
            // Get the API base URL from the hidden field in _Layout.cshtml
            const apiBaseUrl = $('#hdnApiBaseUrl').val();

            // 1. Initial Load: Fetch the list of all products.
            $.ajax({
                url: apiBaseUrl + "/api/products",
                method: 'GET',
                success: function (products) {
                    const tableBody = $('#productsTableBody');
                    tableBody.empty(); // Clear "Loading..." message

                    if (products.length === 0) {
                        tableBody.append('<tr><td colspan="3">No products found.</td></tr>');
                        return;
                    }

                    products.forEach(function (product) {
                        const productRow = `
                            <tr>
                                <td>${product.name}</td>
                                <td>$${product.price.toFixed(2)}</td>
                                <td>
                                    <button class="btn btn-primary btn-sm view-reviews-btn" data-product-id="${product.id}" data-product-name="${product.name}">
                                        View Reviews
                                    </button>
                                </td>
                            </tr>`;
                        tableBody.append(productRow);
                    });
                },
                error: function () {
                    $('#productsTableBody').html('<tr><td colspan="3">Failed to load products.</td></tr>');
                }
            });

            // 2. On-Demand Load: Attach a click handler to load reviews.
            // We use event delegation for buttons that are added dynamically.
            $('#productsTableBody').on('click', '.view-reviews-btn', function () {
                const button = $(this);
                const productId = button.data('product-id');
                const productName = button.data('product-name');

                $('#reviewsHeader').text(`Reviews for: ${productName}`);
                const reviewsArea = $('#reviewsArea');
                reviewsArea.html('<p>Loading reviews...</p>');

                // Make the second, on-demand API call for reviews
                $.ajax({
                    url: `${apiBaseUrl}/api/products/${productId}/reviews`,
                    method: 'GET',
                    success: function (reviews) {
                        reviewsArea.empty();

                        if (reviews.length === 0) {
                            reviewsArea.append('<p>No reviews yet for this product.</p>');
                            return;
                        }

                        reviews.forEach(function (review) {
                            const reviewCard = `
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                        <strong>${review.reviewerName}</strong> rated it ${review.rating} / 5
                                    </div>
                                    <div class="panel-body">
                                        <p>${review.comment}</p>
                                        <small class="text-muted">Reviewed on: ${new Date(review.reviewDate).toLocaleDateString()}</small>
                                    </div>
                                </div>`;
                            reviewsArea.append(reviewCard);
                        });
                    },
                    error: function () {
                        reviewsArea.html('<p class="text-danger">Failed to load reviews.</p>');
                    }
                });
            });
        });
    </script>
}